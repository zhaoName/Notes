# 网络层 - IPv6

<br>


## 一、IPv6 Address

### 0x01 简介

众所周知 32 位的 IPv4 地址已经用完，早在多年前大佬们又推出 128 位的 IPv6 地址，这么庞大的地址数够现有地球人每人拥有上千的 IP 地址。

IPv6 使用冒号将 128 位的二进制数分成 8 个 16 bit 的数组，每个数组一般用 4 个十六进制位表示。

- 完整格式：`F00D:5678:0000:0000:8:987A:200C:4A7A`

- 压缩格式：一连串的 0 可用一对冒号表示，上面 IPv6 地址也可表示为 `F00D:5678::8:987A:200C:4A7A`。但注意一对冒号(::) 在一个地址中只能出现一次。

- 当涉及到 IPv4 和 IPv6 的混合环境时，也可使用 `x:x:x:x:x:x:d.d.d.d` (x 十六进制，d 十进制) 表示。如 `0:0:0:0:0:0:192.168.1.1`，压缩格式为 `::192.168.1.1`

- 地址前缀长度表示法 `F00D:5678:0000:0000:8:987A:200C:4A7A/64`

### 0x02 IPv6 地址类型

#### 单播地址 Unicast

单播地址是点对点通信时使用的地址，此地址仅标识一个接口。单播地址包含：全球单播地址、未指定地址、环回地址。全球单播地址格式如下：

```
+------------------------+-----------+----------------------------+
|         n bits         |   m bits  |       128-n-m bits         |
+------------------------+-----------+----------------------------+
| global routing prefix  | subnet ID |       interface ID         |
+------------------------+-----------+----------------------------+
```

- 现在 IPv6 中网络中 n = 48, m= 16, 128 - m - n = 64

- 全球路由： 根据 ISP 组织，用来分配给站点，是子网/链路的集合
- 子网 ID ：站点子网的标识符，由站点管理员分层地构建
- 接口 ID ：用来标识链路上的接口，在同一子网内是唯一的，接口 ID 通常用 MAC 地址加上一个临时地址构成

#### 链路本地地址 Link-Local Address

链路本地地址是 IPv6 中单播地址的一种，当在一个节点启用 IPv6 协议后，通过配置 IPv6 全球单播地址或配置自动生成的链路本地地址时，节点的每个接口自动生成一个链路本地地址, 它相当于 IPv4 中的 169.254.0.0/16 网段。其格式如下：

```
+----------+-------------------------+----------------------------+
| 10 bits  |         54 bits         |          64 bits           |
+----------+-------------------------+----------------------------+
|1111111010|           0             |       interface ID         |
+----------+-------------------------+----------------------------+
```

这种机制使得两个连接到同一链路的 IPv6 节点不需要做任何配置就可以通信。在本链路上，路由表中看到的下一跳都是对端的链路本地地址，不是公网 IP 地址。只能在本地链路使用，不能在子网间路由。

#### 多播地址 Multcast

多播地址标识一组接口，当数据报的目标地址是多播地址时，网络尽量将其发送到该组的所有接口上。多播地址以 1111 1111 即 FF 开头，是个如下：

```
+------ -+----+----+---------------------------------------------+
|   8    |  4 |  4 |                  112 bits                   |
+------ -+----+----+---------------------------------------------+
|11111111|flgs|scop|                  group ID                   |
+--------+----+----+---------------------------------------------+

```

#### 任播地址 Anycast

任播地址标识一组接口，它与多播的区别在于发送数据报文的方法。向任播地址发送的数据报文并未分配给组内的所有成员，而是发送地址标识的 "最近的(根据路由协议的距离度量)" 那个接口。其格式如下

```
+------------------------------------------------+----------------+
|                         n bits                 |   128-n bits   |
+------------------------------------------------+----------------+
|                   subnet prefix                | 00000000000000 |
+------------------------------------------------+----------------+
```


#### 特殊地址

- 0:0:0:0:0:0:0:0 压缩表示为 :: 是 IPv4 中 0.0.0.0 的等价物，在主机初始化且没有取得自己的地址时，未指定地址可以用在IPv6报文的源地址字段

- 0:0:0:0:0:0:0:1 压缩表示为 ::1 等价于 IPv4 中的 127.0.0.1 
- 0:0:0:0:0:0:192.168.1.1 是 IPv4 和 IPv6 混合网络环境中 IPv4 地址的表示方式
- 2000::/3 (0010 0000 0000 0000::/3) 全球单播地址范围 
- FE80::/10 链路本地地址范围
- FF00::/8 组播地址范围
- 3FFF:FFFF::/32 和 2001:0DB8::/32 为示例和文档保留的地址
- 2002::/16 用于 IPv6 到 IPv4 的转换系统，这种结构允许 IPv6 包通过 IPv4 网络传输，而无需显示的配置隧道。

<br>

## 二、首部

IPv6 首部固定 40 字节长度，为了减轻路由器的负担，省略首部校验和字段，这是因为传输层协议 TCP 或 UDP 在检验校验和时使用伪首部，可以验证 IP 地址是否正确。所以相应的在 IPv6 协议下的传输层协议 TCP 或 UDP 需要强制验证检验和 (IPv4 是可选)。


### 0x01 首部格式

```
IPv6 Header Format

0      		   7    		  15     			23  		  31
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version| Traffic Class |           Flow Label                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Payload Length        |  Next Header  |   Hop Limit   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                         Source Address                        +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                      Destination Address                      +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- 版本 (Version)：占 4 bit，IPv6 中固定为 6

- 通信量类 (Traffic Class)：占 8 bit，相当于 IPv4 中的 TOS 字段，基本不使用。
- 流标号 (Flow Label)：占 20 bit，用于服务质量 QoS 控制
- 有效载荷长度 (Payload Length)：占 16 bit，数据包数据部分长度，若有可选首部，它指可选首部长度和数据长度之和
- 下一个首部 (Next Header)：占 8 bit，相当于 IPv4 中的协议字段，通常表示 IP 的上一层协议是 TCP 或是 UDP。在有 IPv6 扩展首部的情况下，该字段表示后面第一个扩展首部的协议类型。
- 跳数限制 (Hope Limit): 占 8 bit，相当于 IPv4 中的 TTL 字段，数据每经过一个路由器值就减 1，减到 0 则丢弃数据


### 0x02 扩展首部

IPv6 的首部长度对固定，无法将可选项加入其中，取而代之的是通过扩展首部对功能进行了有效扩展。IPv6 的扩展首部可以是任意长度。扩展首部当中还可以包含扩展首部协议以及下一个扩展首部字段。

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Next Header  |  Hdr Ext Len  |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
|                                                               |
.                                                               .
.                            Options                            .
.                                                               .
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- 下一个首部 (Next Header)：后面第一个扩展首部的协议类型

- 扩展首部长度 (Hdr Ext Len)： 扩展首部长度

IPv6首部中没有标识以及标志字段，在需要对IP数据报进行分片时，可以使 用扩展首部。

```
+---------------+----------------+-----------------+-----------------
|  IPv6 header  | Routing header | Fragment header | fragment of TCP
|               |                |                 |  header + data
| Next Header = |  Next Header = |  Next Header =  |
|    Routing    |    Fragment    |       TCP       |
+---------------+----------------+-----------------+-----------------
```

| 扩展首部 | 协议号 |
| ---- | ---- |
| IPv6 逐跳选项 (HOPOPT) | 0 |
| IPv6 路由标头 (IPv6-Route) | 43 |
| IPv6 片首部 (IPv6-Frag) | 44 |
| 载荷加密 (ESP) | 50 |
| 认证首部 (AH)| 51 |
| 首部终止 (IPv6-NoNxt) | 59 |
| 目标地址选项 (IPv6-Opts) | 60 |
| 移动首部 (Mobility Header) | 135 |

<br>


<br>


<br>

参考：

- [IP Version 6 Addressing Architecture](https://tools.ietf.org/html/rfc4291)

- [Internet Protocol, Version 6 (IPv6) Specification](https://tools.ietf.org/html/rfc8200)

<br>