# 应用层 - DHCP & Telnet & RDP

<br>

## 一、DHCP

DHCP (Dynamic Host Configuration Protocol) 动态主机配置协议，前身是 BOOTP 协议。它是一个应用层协议，借助 UDP 协议工作。DHCP 客户端使用 UDP 68 端口，DHCP 服务端使用 UDP 67 端口。

### 0x01 为什么使用 DHCP？

基于 TCP/IP 的网络上的每个设备都必须具有唯一的单播 IP 地址，才能访问网络及其资源。 如果没有 DHCP，必须手动配置从一个子网移到另一个子网的新计算机或计算机的 IP 地址;必须手动回收从网络中删除的计算机的 IP 地址。

对于 DHCP，这整个过程是自动进行的，并集中管理。 DHCP 服务器维护 IP 地址池，并在网络上启动时为任何启用了 DHCP 的客户端租用一个地址。 由于 IP 地址是动态的 (租赁) 而不是静态 (永久分配) ，因此不再使用的地址会自动返回到池中进行重新分配。

DHCP 的优点

- 可靠的 IP 地址配置。 DHCP 最大程度地减少了由手动 IP 地址配置（如录入错误）导致的配置错误，或将 IP 地址分配给多台计算机时导致的地址冲突。

- 降低了网络管理。 DHCP 包含以下功能来减少网络管理：
	- 集中式和自动 TCP/IP 配置。
	- 能够从一个中心位置定义 TCP/IP 配置。
	- 通过 DHCP 选项分配其他所有 TCP/IP 配置值的功能。
	- 有效地处理必须经常更新的客户端的 IP 地址更改，例如，移动到无线网络上不同位置的便携设备的 IP 地址更改。
	- 使用 DHCP 中继代理转发初始 DHCP 消息，这样就无需在每个子网上使用 DHCP 服务器。

### 0x02 DHCP 工作流程



### 0x03 更新租约

DHCP 服务器向 DHCP 客户机出租的 IP 地址一般都有一个租借期限，期满后 DHCP 服务器便会收回出租的IP地址。如果 DHCP 客户机要延长其 IP 租约，则必须更新其 IP 租约。

客户端会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP 服务器发送 DHCP request 消息包。如果客户端接收到该服务器回应的 DHCP ack 消息包，客户端就根据包中所提供的新的租期以及其它已经更新的 TCP/IP 参数，更新自己的配置，IP租用更新完成。如果没有收到该服务器的回复，则客户端继续使用现有的IP地址，因为当前租期还有50%。

如果在租期过去 50% 的时候没有更新，则客户端将在租期过去 87.5% 的时候再次向为其提供 IP 地址的 DHCP 联系。如果还不成功，到租约的 100% 时候，客户端必须放弃这个IP地址重新申请。

如果此时无 DHCP 可用，客户端会使用 169.254.0.0/16 中随机的一个地址，并且每隔 5 分钟再进行尝试。

### 0x04 DHCP 报文格式

```
DHCP format

	0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
   +---------------+---------------+---------------+---------------+
   |                            xid (4)                            |
   +-------------------------------+-------------------------------+
   |           secs (2)            |           flags (2)           |
   +-------------------------------+-------------------------------+
   |                          ciaddr  (4)                          |
   +---------------------------------------------------------------+
   |                          yiaddr  (4)                          |
   +---------------------------------------------------------------+
   |                          siaddr  (4)                          |
   +---------------------------------------------------------------+
   |                          giaddr  (4)                          |
   +---------------------------------------------------------------+
   |                                                               |
   |                          chaddr  (16)                         |
   |                                                               |
   |                                                               |
   +---------------------------------------------------------------+
   |                                                               |
   |                          sname   (64)                         |
   +---------------------------------------------------------------+
   |                                                               |
   |                          file    (128)                        |
   +---------------------------------------------------------------+
   |                                                               |
   |                          options (variable)                   |
   +---------------------------------------------------------------+
```

<br>



<br>



<br>



<br>

参考：

- [DHCP协议详解](https://zhuanlan.zhihu.com/p/265293856)

<br>