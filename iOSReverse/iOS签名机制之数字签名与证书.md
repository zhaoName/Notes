# iOS签名机制之数字签名与证书

<br>

## 一、单向散列函数

单向散列函数(One-way hash function): 也称hash函数，是指将任意长度的消息内容计算出固定长度的散列值。如MD5,常用于生成摘要或密钥加密。

- 消息长度任意，同种算法计算出的散列值长度固定

- 计算速度快，能快速计算出散列值

- 单向性，能根据消息计算出散列值，但不能由散列值反推出消息内容

### 0x01 应用

对于很大的数据来说，要对比数据是否被篡改是很麻烦的事，但用单向散列函数算出散列值再去对比，就很easy。

![输入图片说明](https://images.gitee.com/uploads/images/2019/0108/195214_e79db2ee_1355277.png "Snip20190108_10.png")


**问题: **单向散列函数算出的散列值虽然能用作验证数据是否被篡改，但消息通信时不可能直接将散列值发送过去（由散列值不能反推出消息内容），也不可能将消息明文和消息算出的散列值一起发送过去（会被拦截到，更改消息内容再发送）。那咋办呢？往下看。。。

<br>

## 二、数字签名


数字签名中关键点: 

- 生成签名: 由消息发送者完成，通过"签名钥匙"生成

- 验证签名: 由消息的接受者完成，通过"验证密钥"验证

- 由消息的发送者用自己的私钥进行签名，以保证这个签名是由发送者自己签的。

### 0x01 数字签名过程

![输入图片说明](https://images.gitee.com/uploads/images/2019/0110/211232_7e4c768a_1355277.png "Snip20190110_1.png")

- 当消息发送者发送消息时，先用自己的私钥将消息加密，生成签名

- 发送者将消息和签名一起发送给接收者

- 接收者收到消息的会用公钥将签名解密出来

- 接收者再对比解密后的消息和明文消息，如果一致则签名验证成功，消息没有被篡改。



 **问题:** 这样做虽然能验证消息是否被篡改，但也有缺点 -- 非对称加密计算出来的密文大小和原数据差不多大，这样就当对于发送一条消息要消耗两倍的流量，对数据传输代价有点大。那要咋办呢。。。


### 0x02 数字签名优化

![输入图片说明](https://images.gitee.com/uploads/images/2019/0110/215716_9a0faeba_1355277.png "Snip20190110_3.png")

- 消息发送者生成一对密钥，并将公钥发送给消息接收者；

- 当消息发送者发送消息时，先将消息算出散列值，再用自己的私钥对散列值加密，生成签名；

- 发送者将消息和签名一起发送给接收者；

- 接收者收到消息的会先用公钥将签名解密出来，拿到散列值；

- 接收者再用同样的单向散列函数算出接收消息的散列值，和解密后的散列值对比，如果一致则签名验证成功，消息没有被篡改。


### 0x03 数字签名优缺点

- 能够证明数据的有效性 -- 数据是否被篡改，是否完整；

- 数字签名+单向散列函数，能有效保证数据传送大小问题。

- 数字签名不能保证数据的机密性；

- 若遭遇中间人攻击，公钥被伪造，数字签名将会失效。


### 0x04 中间人攻击

1. 用非对称加密发送消息机制(详情参考[iOS签名机制之非对称加密](https://gitee.com/zhaoName0x01/Notes/blob/master/iOSReverse/iOS签名机制之非对称加密.md))解释中间人攻击

![输入图片说明](https://images.gitee.com/uploads/images/2019/0110/221216_63a2f756_1355277.png "Snip20190110_5.png")


- 公钥和私钥由消息接受者生成，消息发送者向接收者要公钥，但被中间人窃听

- 接收者收到请求会将公钥给发送者，但会被中间人拦截到并保存下来，然后中间人把自己的公钥发给消息发送者

- 消息发送者使用中间人的公钥对消息进行加密 发送给接收者

- 中间人拦截到密文，用自己的密钥将消息解密，然后再伪造数据，用拦截到的公钥加密发给接收者

- 接受者用私钥进行解密，验证数据的正确的。


这样消息的接受者和发送者都能正常收发消息，并且密钥验证也是正确的。但实际上消息的内容已被中间人知晓。

2. 数字签名被中间人攻击

![输入图片说明](https://images.gitee.com/uploads/images/2019/0110/223716_831fef3c_1355277.png "Snip20190110_7.png")


同样在数字签名时，若被中间人攻击 拿到消息发送者的公钥并保存来，也能伪造数据。使数字签名失效。

那如何验证公钥的合法性呢？往下看。。。

<br>

## 二、证书


证书全称公钥证书，有权威机构认证。

- 证书包含生成公钥人的姓名、邮箱、等个人信息，以及公钥

- 由认证机构(Certificate Authority，CA)施加数字签名



### 0x01 证书的使用


![输入图片说明](https://images.gitee.com/uploads/images/2019/0110/224509_16b24da7_1355277.png "Snip20190110_8.png")


- 消息接收者生成私钥和公钥；

- 消息接收者在认证机构注册自己的公钥；

- 认证机构用自己的私钥对接收者的公钥等信息施加数字签名并生成证书；

- 消息发送者会得到认证机构的证书；

- 消息发送者用认证机构的公钥验证数字签名，确认接收者公钥的合法性；

- 发送者用接收者的公钥解密数据 并发送给接收者。


这样基本就能保证数据的有效性，不被中间人攻击。


<br>

**写于2019-01-10**

<br>